---
import type { MarkdownHeading } from "astro";

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;
---

<div class="toc-wrapper">
  <h4 class="toc-title">On this page</h4>
  <nav class="toc-nav">
    <ul class="toc-list">
      <li>
        <a class="toc-link" href={`#${headings[0]?.slug || 'overview'}`} data-depth="1">
          Overview
        </a>
      </li>
      {
        headings.slice(1).map((heading) => (
          <li>
            <a 
              href={`#${heading.slug}`} 
              class="toc-link"
              data-depth={heading.depth}
            >
              {heading.text}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>
</div>

<script>
  // TOC scroll spy functionality
  const setupScrollSpy = () => {
    const tocLinks = document.querySelectorAll('.toc-link');
    const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    const observerOptions = {
      rootMargin: '-80px 0px -80% 0px',
      threshold: 0
    };
    
    const observerCallback = (entries: IntersectionObserverEntry[]) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          
          tocLinks.forEach((link) => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${id}`) {
              link.classList.add('active');
            }
          });
        }
      });
    };
    
    const observer = new IntersectionObserver(observerCallback, observerOptions);
    
    headings.forEach((heading) => {
      if (heading.id) {
        observer.observe(heading);
      }
    });
    
    // Smooth scroll behavior
    tocLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const targetId = link.getAttribute('href')?.slice(1);
        const targetElement = document.getElementById(targetId || '');
        
        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  };
  
  // Run setup when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupScrollSpy);
  } else {
    setupScrollSpy();
  }
</script>

<style>
  .toc-wrapper {
    position: sticky;
    top: calc(var(--header) + 2rem);
    height: fit-content;
  }

  .toc-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--neu-text-secondary);
    margin-bottom: 1rem;
    padding-left: 0.5rem;
  }

  .toc-nav {
    max-height: calc(100vh - var(--header) - 8rem);
    overflow-y: auto;
    padding-right: 0.5rem;
  }

  .toc-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 1px;
    border-left: 1px solid var(--border-color);
  }

  .toc-link {
    display: block;
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    color: var(--neu-text-secondary);
    text-decoration: none;
    transition: all 0.15s ease;
    position: relative;
    margin-left: -1px;
    border-left: 2px solid transparent;
  }

  .toc-link[data-depth="2"] {
    padding-left: 1.5rem;
  }

  .toc-link[data-depth="3"] {
    padding-left: 2.25rem;
  }

  .toc-link[data-depth="4"] {
    padding-left: 3rem;
  }

  .toc-link:hover {
    color: var(--neu-text);
  }

  .toc-link.active {
    color: var(--neu-accent);
    font-weight: 600;
    border-left-color: var(--neu-accent);
  }

  .toc-nav::-webkit-scrollbar {
    width: 4px;
  }

  .toc-nav::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-nav::-webkit-scrollbar-thumb {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
  }

  .toc-nav::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255, 255, 255, 0.18);
  }

  @media (max-width: 1024px) {
    .toc-wrapper {
      position: static;
      padding: 1rem;
    }

    .toc-title {
      font-size: 0.875rem;
      margin-bottom: 1.5rem;
    }
  }
</style>